#!/bin/sh

# ------------------------------------------------------------------------------

# defaults

prefix="/usr/local";

# usage

usage () {
    cat <<EOF
usage: $0 [options]
where available options are:
  --prefix <prefix>  Specify installation prefix directory
                     ("$prefix" by default)
  --help             Display this help and exit
EOF
    exit 0
}

# utils

warn () { echo "Warning: $1" >/dev/stderr; }
info () { echo "$1" >/dev/stderr; }
err () { echo "$1" >/dev/stderr; exit 1; }
arr () { echo "Missing argument for \`$1'!" >/dev/stderr; usage; exit 1; }
arg () { test "x$2" != "x" && echo "$2" || arr "$1"; }

# arg. parsing

while test $# '>' 0; do
    case "$1" in
	--prefix) prefix="$(arg "$1" "$2")"; shift; shift;;
	*) warn "Ignoring argument \`$1'!"; shift;;
    esac;
done;

# ---

# output config file
exec 1>"Makefile.config";
cat Makefile.config.in;

echo "APRON_PREFIX = ${prefix}";

test_cmd () { command -v $1 >/dev/null; }
maybe_cmd () { test_cmd $2 && echo "$1 = $2" || warn "$3 seems unavailable"; }
test_clib () {
    ( cd /tmp; c="$(mktemp --suffix=.c)"; cat - > "$c";
      # Really assume cc?
      cc "$c" "$@" -o /dev/null \
	  && { rm "$c"; return 0; } \
	  || { rm "$c"; return 1; }; )
}

system=$(uname -s);
info "Detected System: ${system}"; 
case "${system}" in
    Linux)
	:;;			# <- defaults are ok.
    Darwin|FreeBSD)
	echo 'GMP_PREFIX = /usr/local';
	echo 'MPFR_PREFIX = /usr/local';
	maybe_cmd "SED" "gsed" "GNU sed";
	maybe_cmd "M4" "gm4" "GNU m4";;
    *)
	err "Unknown System!";;
esac;

ocamlfind query gmp 2>&1 >/dev/null || err "Missing mlgmpidl!";

test_ppl () {
    test_clib -lppl_c -lppl <<EOF
#include <ppl_c.h>
#ifndef PPL_VERSION_MAJOR
# error "No PPL header"
#endif
int main() { ppl_initialize(); return ppl_finalize(); }
EOF
}

test_ppl \
    && { info "PPL library found."; echo 'HAS_PPL = 1'; } \
    || { info "PPL library not found."; }

# ------------------------------------------------------------------------------
